<htmlform formName="Sickle Cell Disease Visit"
          formUuid="E68275D4-C300-46B0-8754-4C2CF2598B78"
          formEncounterType="D4073EB7-60B1-4586-B062-13FCE4CBC9E8"
          formVersion="1.0">

    <macros>
        <macro key="noAnswer" value="6557646c-977f-11e1-8993-905e29aff6c1" />
        <macro key="yesAnswer" value="65576354-977f-11e1-8993-905e29aff6c1" />
        <!--Vital Sgns and Labs-->
        <macro key="height" value="6569c562-977f-11e1-8993-905e29aff6c1" />
        <macro key="weight" value="6569c44a-977f-11e1-8993-905e29aff6c1" />
        <macro key="wtChange" value="1be55e42-9a11-11e8-9eb6-529269fb1459" />
        <macro key="systolicBP" value="6569bffe-977f-11e1-8993-905e29aff6c1" />
        <macro key="diastolicBP" value="6569c116-977f-11e1-8993-905e29aff6c1" />
        <macro key="heartRate" value="6569c224-977f-11e1-8993-905e29aff6c1" />
        <macro key="Creatinine" value="657170a0-977f-11e1-8993-905e29aff6c1" />
        <macro key="urineProtein" value="65717366-977f-11e1-8993-905e29aff6c1" />
        <macro key="noUrineProtein" value="654994c2-977f-11e1-8993-905e29aff6c1" />
        <macro key="trace" value="6572cf72-977f-11e1-8993-905e29aff6c1" />
        <macro key="weaklyPos" value="65598fb2-977f-11e1-8993-905e29aff6c1" />
        <macro key="moderatelyPos" value="65597cde-977f-11e1-8993-905e29aff6c1" />
        <macro key="stronglyPos" value="65598706-977f-11e1-8993-905e29aff6c1" />
        <!--Signs and Symptoms-->
        <macro key="confusion" value="657592c0-977f-11e1-8993-905e29aff6c1" />
        <macro key="patientHasFatigue" value="71195f66-a9c7-4c33-b6be-90ef9ff9535f" />
        <macro key="patientHasNausea" value="104cb8fb-8ff9-4ea4-b547-10fed3afdea2" />
        <macro key="patientHasAnorexia" value="ac7a7aae-6f3a-4a04-a147-97019597886f" />
        <macro key="patientHasPruritus" value="ca2cd277-cdfc-42b0-9958-3f1281480ad8" />
        <macro key="patientHasAscites" value="2b0f959a-8877-434b-8cc4-430682e7c9f4" />
        <macro key="symptomsOther" value="654b3fac-977f-11e1-8993-905e29aff6c1" />

        <macro key="tookMedicToday" value="5f91e983-f825-4f41-81de-077288a5d860" />

        <macro key="conjunctiva" value="6560c728-977f-11e1-8993-905e29aff6c1" />
        <macro key="pinkConjunctiva" value="65638ef4-977f-11e1-8993-905e29aff6c1" />
        <macro key="paleConjunctiva" value="6548a256-977f-11e1-8993-905e29aff6c1" />
        <macro key="edema" value="bd057502-c23b-4f80-b24c-b996e8a84dfc" />
        <macro key="ckdStage" value="fd79ad7e-53ea-461a-b075-27beee44a6cc" />
        <macro key="OneTwoCKDStage" value="d45b3164-bdb1-4411-9f22-d998c9af116c" />
        <macro key="threeCKDStage" value="358c0e8f-708a-48f3-ba2c-e7fe16a24cfd" />
        <macro key="fourFiveCKDStage" value="d0a884e6-8bb5-451c-a321-f63242d216b7" />
        <macro key="nsaidUse" value="89a3d604-43f9-4d4e-95ad-8b8577f80108" />
        <macro key="glomerularFRate" value="a0d7e2b0-d69c-11e8-9f8b-f2801f1b9fd1" />
        <macro key="tobacco" value="655a4dc6-977f-11e1-8993-905e29aff6c1" />
        <macro key="alcohol" value="655a4ed4-977f-11e1-8993-905e29aff6c1" />
        <macro key="current" value="655a4cc2-977f-11e1-8993-905e29aff6c1" />
        <macro key="never" value="65577f4c-977f-11e1-8993-905e29aff6c1" />
        <macro key="stopped" value="655a4ab0-977f-11e1-8993-905e29aff6c1" />
        <macro key="none" value="6557987e-977f-11e1-8993-905e29aff6c1" />
        <macro key="drugSet" value="447aaa7a-cd03-11e5-9956-625662870761" />
        <macro key="drugsNow" value="65585192-977f-11e1-8993-905e29aff6c1" />
        <!-- diuretic=8466 -->
        <macro key="hydrochlorothiazide" value="65588df6-977f-11e1-8993-905e29aff6c1" />
        <macro key="furosemide" value="6546003c-977f-11e1-8993-905e29aff6c1" />
        <macro key="spironolactone" value="65694c36-977f-11e1-8993-905e29aff6c1" />
        <!-- ccBlocker=8465 -->
        <macro key="amlodipine" value="65635ef2-977f-11e1-8993-905e29aff6c1" />
        <macro key="nifedipineModifiedRelease" value="654704dc-977f-11e1-8993-905e29aff6c1" />
        <!-- aceInhibit=8464 -->
        <macro key="enalapril" value="65588cde-977f-11e1-8993-905e29aff6c1" />
        <macro key="captopril" value="6563597a-977f-11e1-8993-905e29aff6c1" />
        <macro key="lisinopril" value="65635a74-977f-11e1-8993-905e29aff6c1" />
        <!-- betaBlocker=8463 -->
        <macro key="atenolol" value="65635d58-977f-11e1-8993-905e29aff6c1" />
        bisoprolol=8612
        <macro key="propranolol" value="65470f18-977f-11e1-8993-905e29aff6c1" />
        <macro key="dietRecommendations" value="ccc842f5-c7ee-4b82-865c-be19053c4db3" />
        <macro key="sodiumLow" value="5e7a1d78-aecc-4b47-bc81-d144dc91dda1" />
        <macro key="potassiumLow" value="0ddfbe32-04c3-4b03-a057-ca3b5524cbb5" />
        <macro key="proteinLow" value="f8770f87-1834-4331-a8f5-88df5e6f9573" />
        <macro key="caloriesHigh" value="3cfde72e-8626-4ee2-97e8-6f40172953f5" />
        <macro key="medicationOther" value="c8a4d207-0a73-4471-955c-c1f47cbbe2b5" />
        <macro key="nextAppt" value="6569cbd4-977f-11e1-8993-905e29aff6c1" />
        <macro key="nenoLocations" expression="fn.globalProperty('pihmalawi.systemLocationsTag')"/>
        <macro key="formEncTypeUuid" value="1ebe2272-974e-11e8-9eb6-529269fb1459"/>

        <macro key="dispensingConstruct" value="3269F65B-1A28-42EE-8578-B9658387AA00"/>
        <macro key="medicationName" value="65585192-977f-11e1-8993-905e29aff6c1"/>
        <macro key="qPerDose" value="160856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
        <macro key="dosingUnit" value="162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
        <macro key="milliGram" value="161553AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
        <macro key="milliLiter" value="162263AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
        <macro key="capsule" value="6569265c-977f-11e1-8993-905e29aff6c1"/>
        <macro key="tablet" value="656921d4-977f-11e1-8993-905e29aff6c1"/>
        <macro key="routeOfAdmin" value="b08011b8-b1c7-4fd0-b48d-65a475397639"/>
        <macro key="oral" value="65640244-977f-11e1-8993-905e29aff6c1"/>
        <macro key="intravenous" value="65640348-977f-11e1-8993-905e29aff6c1"/>
        <macro key="drugFrequency" value="6563fb14-977f-11e1-8993-905e29aff6c1"/>
        <macro key="medicationDuration" value="159368AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
        <macro key="timeUnits" value="f1904502-319d-4681-9030-e642111e7ce2"/>
        <macro key="amountDispensed" value="65614392-977f-11e1-8993-905e29aff6c1"/>
        <macro key="adminInstructions" value="ef7f742b-76e6-4a83-84ca-534ad6705494"/>
    </macros>

    <ifMode mode="VIEW" include="false">

        <script type="text/javascript">

            jq(function() {

            var searchNextApptDate = function() {
            var nextAppointDateValue = jq("span#appointmentDate input[type='hidden']").val();
            if (!nextAppointDateValue) {
            // if value was not entered yet then search within other followup encounters on the same day
            var visitDateInput = jq("span#visitDate input[type='hidden']").val();
            // the Visit Date is in the format YYYY-MM-DD
            var dateParts = visitDateInput.split("-");
            // month is 0-based, that's why we need dataParts[1] - 1
            var visitDate = new Date(+dateParts[0], dateParts[1] - 1, +dateParts[2]);

            var nextAppointDate = '<lookup expression="fn.latestObs(5096).getValueDatetime()"/>';
            if (nextAppointDate) {
            var latestNextAppointDate = new Date(nextAppointDate);
            var obsDatetime = '<lookup expression="fn.latestObs(5096).getObsDatetime()"/>';
            if (obsDatetime) {
            var jsObsDatetime = new Date(obsDatetime);
            if ( visitDate.getFullYear() ===  jsObsDatetime.getFullYear() &amp;&amp;
            visitDate.getMonth() === jsObsDatetime.getMonth() &amp;&amp;
            visitDate.getDate() === jsObsDatetime.getDate() ) {
            //we found a Next Appointment Date set on the same day on a different encounter
            var appointDateWidget = getField('appointmentDate.value').datepicker('setDate', latestNextAppointDate);
            setValue('appointmentDate.value', latestNextAppointDate);
            jq("#appointmentDate").children("input[type=hidden]").first().trigger('change');
            }
            }
            }
            }
            }

            var findNextApptDate = setInterval(function() {
            searchNextApptDate();
            clearInterval(findNextApptDate);
            }, 500);
            });

        </script>
    </ifMode>

    <!-- Flowsheet table view -->
    <ifMode mode="VIEW" include="true">

        <table class="visit-table data-entry-table">
            <thead class="visit-table-header">
                <tr> <!-- Label row -->
                    <td rowspan="2">Visit Date</td>
                    <td colspan="6"><span>Vital Signs and Labs</span></td>
                    <td rowspan="2">Next Visit Date</td>
                </tr>
                <tr> <!-- Units row -->
                    <td>Ht (cm)</td>
                    <td>Wt (kg)</td>
                    <td>Wt Change (kg)</td>
                    <td>Bp (mmh/g)</td>
                    <td>GFR (mL/min)</td>
                    <td>HR</td>
                </tr>
            </thead>
            <tbody class="visit-table-body">
                <tr class="visit-table-row">
                    <td class="nowrap visit-date">
                        <encounterDate/>
                    </td>

                    <td>
                        <!-- Height -->
                        <obsreference conceptId="$height" id="heightEntered" size="3"/>
                    </td>
                    <td>
                        <!-- Weight -->
                        <obsreference conceptId="$weight" id="weightInput" size="3"/>
                    </td>

                    <td>
                        <!-- Weight change -->
                        <obs conceptId="$wtChange" />
                    </td>

                    <td>
                        <!-- BP -->
                        <obsreference conceptId="$systolicBP" />/<obsreference conceptId="$diastolicBP" />
                    </td>

                    <td>
                        <!-- Glomerular Filtration Rate -->
                        <obs conceptId="$glomerularFRate" />
                    </td>

                    <td>
                        <!-- Heart Rate -->
                        <obs conceptId="$heartRate" />
                    </td>

                    <td>
                        <!-- Next appointment -->
                        <obs conceptId="$nextAppt" id="appointmentDate" allowFutureDates="true" allowOverride="true"/>
                    </td>
                </tr>
            </tbody>
        </table>

    </ifMode>

    <!-- Data entry view -->
    <ifMode mode="VIEW" include="false">

        <h4 style="font-style: italic;">
            <b>Chronic Kidney Disease Patient Card</b>
            <span style="padding-left:50px;">Version 1</span>
            <span id="patientUuid" style="display:none"><lookup expression="patient.uuid"/></span>
            <span style="padding-left:50px;">
                <b style="padding-right:10px;">Chronic Care no: </b>
                <b>
                    <lookup complexExpression="#foreach( $id in $patientIdentifiers.get(&quot;Chronic Care Number&quot;) ) $!id #end" />
                </b>
            </span>
        </h4>

        <span style="display:none"><encounterProvider default="16576" /></span> <!-- Set provider to a default as not used -->

        <table class="visit-edit-table">
            <tr>
                <th>Visit Date</th>
                <td><lookup complexExpression="#if($encounter) $ui.format($encounter.encounterDatetime) #else $ui.format($context.defaultEncounterDate) #end" />
                    <span id="visitDateError" class="error field-error" style="display:none;color: rgb(255, 0, 0);"></span>
                    <span style="display:none"><encounterDate id="visitDate" size="20" /></span>
                </td>
            </tr>
            <tr>
                <th>Visit Location</th>
                <td><encounterLocation id="visitLocation" tags="$nenoLocations"/></td>
            </tr>

            <tr>
                <!-- Height -->
                <th>Height</th>
                <td class="focus-field"><obsreference conceptId="$height" id="heightInput" showUnits="true"/></td>
            </tr>
            <tr>
                <!-- Weight -->
                <th>Weight</th>
                <td><obsreference conceptId="$weight" id="weightInput" showUnits="true"/></td>
            </tr>

            <tr>
                <th>Weight change</th>
                <td><obs conceptId="$wtChange" /></td>
            </tr>

            <tr>
                <th>Blood Pressure</th>
                <td>
                    <obsreference conceptId="$systolicBP" />/<obsreference conceptId="$diastolicBP" />
                </td>
            </tr>

            <tr>
                <th>GFR</th>
                <td><obs conceptId="$glomerularFRate" showUnits="true" /></td>
            </tr>

            <tr>
                <th>Heart Rate</th>
                <td><obs conceptId="$heartRate" showUnits="true" /></td>
            </tr>
            
            <tr>
                <th>Next appointment</th>
                <td><obs conceptId="$nextAppt" id="appointmentDate" allowFutureDates="true" allowOverride="true"/></td>
            </tr>

        </table>
        <submit />
    </ifMode>

</htmlform>
